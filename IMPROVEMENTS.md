# Покращення алгоритму видачі листів та добавлення Redis

## Зміни

### 1. Redis в Docker

-   ✅ Добавлений Redis сервіс в `docker-compose.yml`
-   ✅ Redis запускається на порту 6379
-   ✅ Автоматичне збереження даних на диск (`appendonly yes`)
-   ✅ Health check для моніторингу стану

### 2. Покращена логіка видачі листів

-   ✅ Листи більше не повторюються часто
-   ✅ Система запам'ятовує останні 15 показаних листів (за 24 години)
-   ✅ Випадковий вибір тільки з нових листів
-   ✅ Коли всі листи показано, історія очищується

### 3. Нові функції API

#### Отримати випадковий лист (без повторень)

```
GET /api/emails/random
Authorization: Bearer {token}
```

**Відповідь:**

```json
{
    "email": {
        "id": "1",
        "subject": "Невідкладне: Верифікуйте ваш рахунок PayPal",
        "from": "security@paypal-verify.com",
        "body": "<html>...</html>",
        "difficulty": "medium",
        "category": "paypal"
    }
}
```

#### Отримати лист за категорією

```
GET /api/emails/category/{category}
Authorization: Bearer {token}
```

**Параметри:**

-   `category` - категорія листа (напр. "paypal", "amazon", "banking", тощо)

**Відповідь:**같як для random листа, але за конкретною категорією

#### Отримати деталі листа (з правильною відповіддю)

```
GET /api/emails/details/{id}
Authorization: Bearer {token}
```

**Відповідь:**

```json
{
    "email": {
        "id": "1",
        "subject": "Невідкладне: Верифікуйте ваш рахунок PayPal",
        "from": "security@paypal-verify.com",
        "body": "<html>...</html>",
        "difficulty": "medium",
        "category": "paypal",
        "isPhishing": true,
        "indicators": [
            "Посилання вказує на невідомий домен...",
            "Спеціальна термінологія..."
        ],
        "explanation": "Це класичний фішинг для крадіжки облікових даних..."
    }
}
```

#### Отримати історію показаних листів

```
GET /api/emails/history
Authorization: Bearer {token}
```

**Відповідь:**

```json
{
  "emails": [
    { "id": "1", "subject": "...", ... },
    { "id": "5", "subject": "...", ... }
  ],
  "count": 2
}
```

#### Очистити історію листів

```
DELETE /api/emails/history
Authorization: Bearer {token}
```

### 4. Конфіг Redis

Файл `src/config/redis.ts`:

-   Підключення до Redis з конфігурацією переconnect
-   Автоматична переconnect при розриві
-   Graceful shutdown при завершенні сервера

### 5. Утиліти для управління листами

Файл `src/utils/email-distribution.utils.ts`:

-   `getShownEmails()` - отримати список показаних листів
-   `addShownEmail()` - додати лист до історії
-   `getRandomUnshownEmail()` - отримати непоказаний лист
-   `getRandomEmailByCategory()` - отримати лист за категорією
-   `clearUserEmailHistory()` - очистити історію користувача

## Установка

### 1. Установити Redis пакет

```bash
npm install redis
```

### 2. Запустити Docker контейнери

```bash
docker-compose up -d
```

Це запустить:

-   PostgreSQL на порту 5432
-   Redis на порту 6379

### 3. Розробка

```bash
npm run dev
```

## Як це працює

1. **При першому запиті** користувача до `/random`:

    - Система перевіряє Redis на наявність історії листів для користувача
    - Якщо історія порожня, вибирає випадковий лист з усіх доступних
    - Зберігає ID листа в Redis з TTL 24 години

2. **При наступних запитах**:

    - Перевіряє Redis на наявність показаних листів
    - Фільтрує список всіх листів, виключаючи показані
    - Вибирає випадковий з відфільтрованого списку
    - Додає новий ID до історії

3. **По закінченню 24 годин**:
    - Redis автоматично видаляє ключ
    - Історія очищується
    - Користувач знову може бачити ті ж листи

## Переваги

✅ **Відсутність повторень** - користувач бачить нові листи частіше  
✅ **Швидке отримання** - Redis дуже швидко працює в пам'яті  
✅ **Масштабованість** - легко обслуговувати тисячі користувачів  
✅ **Персоналізація** - кожен користувач має власну історію  
✅ **Гнучкість** - можна налаштувати TTL і кількість збережених листів

## Параметри для налаштування

У файлі `src/utils/email-distribution.utils.ts`:

```typescript
const SHOWN_EMAILS_EXPIRY = 86400; // 24 часи в секундах
const MAX_RECENT_EMAILS = 15; // Максимум листів для запам'ятовування
```

Ви можете змінити ці значення за вашими потребами:

-   Зменшити `SHOWN_EMAILS_EXPIRY` для більшої різноманітності
-   Збільшити `MAX_RECENT_EMAILS` для довшої історії
